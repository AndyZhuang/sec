f.fields_for :lessons, lesson do |l|
  l.input :level_id, as: :select, required: true, collection: topic.lessons.unused_levels if lesson.new_record?
  l.input :duration_hours, as: :number, label: 'Hours'
  l.input :duration_minutes, as: :number, label: 'Minutes'
  l.input :instructors, as: :number
  l.input :students, as: :number
  l.input :objective
  l.input :body, as: :ckeditor

  l.has_many :prereq_resources,
             heading: false,
             allow_destroy: true,
             new_record: "Add a prerequisite" do |p|
    p.input :resource_type, as: :hidden,
            input_html: { value: "Lesson" }
    p.input :resource, as: :select,
            label: "Prerequisites", collection: Lesson.all
  end

  l.has_many :materials,
             heading: "Lesson Materials",
             new_record: "Add File",
             allow_destroy: true do |t|
    if t.object.new_record?
      t.input :attachment
    else
      content_tag(:li, class: "input label") do
        label_tag("Attachment") +
        link_to(t.object.attachment_file_name, t.object.attachment.url)
      end
    end
  end

  l.input :_destroy, as: :boolean, label: 'Delete this level' if lesson.persisted?
end

